function e(e){for(var t=e[0],r=1,n=arguments.length;r<n;r++)t+=arguments[r]+e[r];return t}const t=new WeakMap,r=e=>new o(e),n=(e,...r)=>{const{t:n,v:s}=((e,t)=>{const r=[e[0]],n=[];for(let s=0,l=0,c=0,{length:a}=t;l<a;l++)t[l]instanceof o?r[s]+=t[l].v+e[l+1]:(n[c++]=l,r[++s]=e[l+1]);return{t:r,v:n}})(e,r),l=t.get(e)||t.set(e,{}).get(e);return(l[n]||(l[n]=[n])).concat(s.map((e=>r[e])))};function o(e){this.v=e}const s=(e,t)=>(r,...o)=>new Promise(((s,c)=>{r.some(a)&&c(l(new Error("SQLITE_ERROR: SQL injection hazard")));const[i,...u]=n(r,...o);e[t](i.join("?"),u,((e,t)=>{e?c(e):s(t)}))})),l=e=>(e.code="SQLITE_ERROR",e),c=(t,...n)=>r(e(t,...n)),a=e=>e.includes("?");const{assign:i}=Object,u="function"==typeof importScripts,p=u?".":import.meta.url.replace(/\/[^/]*$/,""),d=e=>new Promise(((t,r)=>{const n=()=>{const e=self.module.exports;delete self.exports,self.module=void 0,t(e)};if(self.exports={},self.module={exports:exports},u)importScripts(e),n();else{const{head:t}=document;i(t.appendChild(document.createElement("script")),{onload(){t.removeChild(this),n()},onerror:r,src:e})}})),m=(e,t=1)=>new Promise(((r,n)=>{i(indexedDB.open(e,t),{onupgradeneeded({target:{result:e,transaction:t}}){e.objectStoreNames.contains("sqlite")||e.createObjectStore("sqlite").createIndex("buffer","buffer",{unique:!0}),i(t,{oncomplete(){r(e)}})},onsuccess({target:{result:e}}){r(e)},onerror:n})})),f=(e={})=>new Promise(((t,r)=>{const n=e.dist||p;d(n+"/sql-wasm.js").then((({default:o})=>{Promise.all([m(e.name||"sqlite-worker"),o({locateFile:e=>n+"/"+e})]).then((([n,{Database:o}])=>{const l=e=>n.transaction(["sqlite"],e).objectStore("sqlite");i(l("readonly").get("buffer"),{onsuccess(){let r=Promise.resolve();const{result:n}=this,a=new o(n||e.database||new Uint8Array(0)),u=()=>{r=r.then((()=>new Promise(((t,r)=>{const n=a.export();i(l("readwrite").put(n,"buffer").transaction,{oncomplete(){t(),e.update&&e.update(n)},onabort:r,onerror:r})}))))};n||u();const{all:p,get:d,query:m,raw:f}=function(e){return{all:s(e,"all"),get:s(e,"get"),query:s(e,"run"),raw:c}}({all(e,t,r){try{const n=a.exec(e,t),o=[];n.forEach(h,o),r(null,o)}catch(e){r(e)}},get(e,t,r){try{const n=a.exec(e+" LIMIT 1",t),o=[];n.forEach(h,o),r(null,o.shift()||null)}catch(e){r(e)}},run(e,t,r){try{r(null,a.run(e,t))}catch(e){r(e)}}});let w=0;t({all:p,get:d,raw:f,query(t){return/\b(?:INSERT|DELETE|UPDATE)\b/i.test(t[0])&&(clearTimeout(w),w=setTimeout(u,e.timeout||250)),m.apply(this,arguments)}})},onerror:r})}),r)}))}));function h({columns:e,values:t}){for(let{length:r}=t,n=0;n<r;n++){const r=t[n],o={};for(let{length:t}=e,n=0;n<t;n++)o[e[n]]=r[n];this.push(o)}}const w=new Map,g=(t,...n)=>r(e(t,...n));let b=0;function y(e={}){const{credentials:t}=e,r=e.dist||p,o=e.worker||r+"/worker.js",s=e=>(t,...r)=>{const[o,...s]=n(t,...r);return l(e,{template:o,values:s})},l=(e,t)=>new Promise(((r,n)=>{const o=b++;w.set(o,{resolve:r,reject:n}),c.postMessage({id:o,action:e,options:t})})),c=i(new Worker(/^(?:\.|\/)/.test(o)?o:(e=>URL.createObjectURL(new Blob([`importScripts('${e}')`],{type:"text/javascript"})))(o),{credentials:t}),{onmessage({data:{id:e,result:t,error:r}}){const{resolve:n,reject:o}=w.get(e);w.delete(e),r?o(r):n(t)}});return l("init",i({dist:r,library:r+"/init.js"},e)).then((()=>({all:s("all"),get:s("get"),query:s("query"),raw:g})))}export{y as SQLiteWorker,f as init};
